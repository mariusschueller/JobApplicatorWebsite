<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume and Job Application Manager</title>

</head>

<body>
    <h1>Resume and Job Application Manager</h1>

    <!-- Personal Information -->
    <button onclick="showPersonalDetails()">Show Personal Info</button>
    <button onclick="editPersonalDetails()">Edit Personal Details</button>

    <!-- Professional Details -->
    <button onclick="showProfessionalDetails()">Show Professional Details</button>
    <button onclick="addProfessionalDetail()">Add Professional Detail</button>

    <!-- Experience Details -->
    <button onclick="showExperienceDetails()">Show Experience Details</button>
    <button onclick="addExperienceDetail()">Add Experience Detail</button>



    <!-- Job Application -->
    <h2>Job Application</h2>
    <button onclick="editJobApplication()">Add Job Application</button>
    <button onclick="showJobApplication()">Show Job Application</button>

    <!-- AI Section -->
    <!-- <h2>Generate AI Content</h2>
    <button onclick="generateAIContent()">Generate AI Bullet Points</button>
    <div id="bulletPointsArea" style="margin-top: 20px;"></div> -->

    <!-- Generate Keywords -->
    <!-- <button onclick="generateKeywords()">Generate Keywords</button> -->
    <button onclick="decideExperiences()">Get AI Content</button>
    <button onclick="showKeywords()">Show Keywords</button>
    <button onclick="showAIExperiences()">Show AI Content</button>

    <!-- Generate Resume -->
    <button onclick="generateResume()">Generate Resume</button>

    <!-- Cover Letter -->
    <button onclick="generateCoverLetter()">Generate Cover Letter</button>

    <!-- Local Storage Export and Import -->
    <h2>Storage</h2>
    <button onclick="exportLocalStorage()">Export Local Storage</button>
    <input type="file" id="importFile" style="display:none" onchange="importLocalStorage(event)">
    <button onclick="document.getElementById('importFile').click()">Import Local Storage</button>

    <!-- Display Area -->
    <div id="displayArea" style="margin-top: 20px; font-family: Arial, sans-serif;"></div>

    <script>
        const OPENAI_API_KEY = "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"; // Replace with your OpenAI key

        const languages = ["Python", "JavaScript", "Java", "C", "C#", "C\\+\\+", "TypeScript", "Swift", "Kotlin", "PHP", "Rust",
            "Go", "Ruby", "SQL", "R", "MATLAB", "Shell", "Objective-C", "Assembly", "Prolog", "PowerShell",
            "Bash", "HTML", "CSS", "XML", "Unity", "Arduino", "Unreal Engine", "Agile"];

        let jobData = JSON.parse(localStorage.getItem("jobApplication")) || { title: "Not Set", company: "Not Set", description: "Not Set" };

        // Personal Information
        let data = JSON.parse(localStorage.getItem("applicantData")) || {
            name: "John Doe",
            location: "New York, NY",
            major: "Computer Science",
            minor: "Mathematics",
            gpa: "4.0",
            school: "University of Example",
            gradYear: "2023",
            website: "https://example.com",
            email: "john.doe@example.com",
            github: "https://github.com/johndoe",
            phone: "123-456-7890",
            classes: "Algorithms, Data Structures, Operating Systems",
            languages: "JavaScript, Python, C++",
            technologies: "React, Node.js, Docker"
        };
        let bulletPoints = [];

        /* -------- PROFESSIONAL DETAILS -------- */

        let professionalDetails = JSON.parse(localStorage.getItem("professionalDetails")) || [];

        function showProfessionalDetails() {
            let html = "<h2>Professional Details</h2>";
            professionalDetails.forEach((detail, index) => {
                html += `<div>
                            <h3>${detail.title}</h3>
                            <p><strong>Dates:</strong> ${detail.dates}</p>
                            <p><strong>Location:</strong> ${detail.location}</p>
                            <p><strong>Role:</strong> ${detail.role}</p>
                            <ul>${detail.bulletPoints.map(b => `<li>${b}</li>`).join("")}</ul>
                            <button onclick="editProfessionalDetail(${index})">Edit</button>
                         </div>`;
            });
            displayArea.innerHTML = html;
        }

        function editProfessionalDetail(index) {
            const detail = professionalDetails[index];
            document.getElementById("displayArea").innerHTML = `
            <h2>Edit Professional Detail</h2>
            <form id="professionalForm">
                <label>Title: <input id="title" value="${detail.title}"></label><br>
                <label>Dates: <input id="dates" value="${detail.dates}"></label><br>
                <label>Location: <input id="location" value="${detail.location}"></label><br>
                <label>Role: <input id="role" value="${detail.role}"></label><br>
                <label>Bullet Points: <textarea id="bulletPoints">${detail.bulletPoints.join("\n")}</textarea></label><br>
                <button type="button" onclick="saveProfessionalDetail(${index})">Save</button>
                <button type="button" onclick="deleteProfessionalDetail(${index})">Delete</button>
            </form>
            `;
        }

        function deleteProfessionalDetail(index) {
            if (confirm("Are you sure you want to delete this professional detail?")) {
                professionalDetails.splice(index, 1);
                localStorage.setItem("professionalDetails", JSON.stringify(professionalDetails));
                showProfessionalDetails();
            }
        }

        function saveProfessionalDetail(index) {
            const detail = {
                title: document.getElementById("title").value,
                dates: document.getElementById("dates").value,
                location: document.getElementById("location").value,
                role: document.getElementById("role").value,
                bulletPoints: document.getElementById("bulletPoints").value.split("\n").filter(b => b.trim())
            };
            professionalDetails[index] = detail;
            localStorage.setItem("professionalDetails", JSON.stringify(professionalDetails));
            alert("Professional detail saved!");
            showProfessionalDetails();
        }

        function addProfessionalDetail() {
            const newDetail = {
                title: "New Title",
                dates: "New Dates",
                location: "New Location",
                role: "New Role",
                bulletPoints: ["New Bullet Point"]
            };
            professionalDetails.push(newDetail);
            editProfessionalDetail(professionalDetails.length - 1);
        }

        /* -------- EXPERIENCE DETAILS -------- */

        let experienceDetails = JSON.parse(localStorage.getItem("experienceDetails")) || [];

        function showExperienceDetails() {
            let html = "<h2>Experience Details</h2>";
            experienceDetails.forEach((detail, index) => {
                html += `<div>
                            <h3>${detail.title}</h3>
                            <p><strong>Dates:</strong> ${detail.dates}</p>
                            <p><strong>Location:</strong> ${detail.location}</p>
                            <p><strong>Role:</strong> ${detail.role}</p>
                            <ul>${detail.bulletPoints.map(b => `<li>${b}</li>`).join("")}</ul>
                            <button onclick="editExperienceDetail(${index})">Edit</button>
                         </div>`;
            });
            displayArea.innerHTML = html;
        }

        function editExperienceDetail(index) {
            const detail = experienceDetails[index];
            document.getElementById("displayArea").innerHTML = `
            <h2>Edit Experience Detail</h2>
            <form id="experienceForm">
                <label>Title: <input id="title" value="${detail.title}"></label><br>
                <label>Dates: <input id="dates" value="${detail.dates}"></label><br>
                <label>Location: <input id="location" value="${detail.location}"></label><br>
                <label>Role: <input id="role" value="${detail.role}"></label><br>
                <label>Bullet Points: <textarea id="bulletPoints">${detail.bulletPoints.join("\n")}</textarea></label><br>
                <button type="button" onclick="saveExperienceDetail(${index})">Save</button>
                <button type="button" onclick="deleteExperienceDetail(${index})">Delete</button>
            </form>
            `;
        }

        function
            deleteExperienceDetail(index) {
            if (confirm("Are you sure you want to delete this Experience detail?")) {
                experienceDetails.splice(index, 1);
                localStorage.setItem("experienceDetails", JSON.stringify(experienceDetails));
                showExperienceDetails();
            }
        }

        function
            saveExperienceDetail(index) {
            const
                detail = {
                    title: document.getElementById("title").value,
                    dates: document.getElementById("dates").value,
                    location: document.getElementById("location").value,
                    role: document.getElementById("role").value,
                    bulletPoints: document.getElementById("bulletPoints").value.split("\n").filter(b => b.trim())
                };
            experienceDetails[index] = detail;
            localStorage.setItem("experienceDetails", JSON.stringify(experienceDetails));
            alert("Experience detail saved!");
            showExperienceDetails();
        }

        function addExperienceDetail() {
            const newDetail = {
                title: "New Title",
                dates: "New Dates",
                location: "New Location",
                role: "New Role",
                bulletPoints: ["New Bullet Point"]
            };
            experienceDetails.push(newDetail);
            editExperienceDetail(experienceDetails.length - 1);
        }

        const displayArea = document.getElementById("displayArea");

        /* -------- PERSONAL DETAILS -------- */
        function showPersonalDetails() {
            displayArea.innerHTML = `<h2>Current Personal Information</h2>
            <p><strong>Name:</strong> ${data.name}</p>
            <p><strong>Location:</strong> ${data.location}</p>
            <p><strong>Major:</strong> ${data.major}</p>
            <p><strong>Minor:</strong> ${data.minor}</p>
            <p><strong>GPA:</strong> ${data.gpa}</p>
            <p><strong>School:</strong> ${data.school}</p>
            <p><strong>Graduation Year:</strong> ${data.gradYear}</p>
            <p><strong>Website:</strong> <a href="${data.website}">${data.website}</a></p>
            <p><strong>Email:</strong> ${data.email}</p>
            <p><strong>GitHub:</strong> <a href="${data.github}">${data.github}</a></p>
            <p><strong>Phone:</strong> ${data.phone}</p>
            <p><strong>Classes:</strong> ${data.classes}</p>
            <p><strong>Languages:</strong> ${data.languages}</p>
            <p><strong>Technologies:</strong> ${data.technologies}</p>`;
        }

        function editPersonalDetails() {
            document.getElementById("displayArea").innerHTML = `
            <h2>Edit Personal Details</h2>
            <form id="editForm">
                <label>Name: <input id="name" value="${data.name}"></label><br>
                <label>Location: <input id="location" value="${data.location}"></label><br>
                <label>Major: <input id="major" value="${data.major}"></label><br>
                <label>Minor: <input id="minor" value="${data.minor}"></label><br>
                <label>GPA: <input id="gpa" value="${data.gpa}"></label><br>
                <label>School: <input id="school" value="${data.school}"></label><br>
                <label>Graduation Year: <input id="gradYear" value="${data.gradYear}"></label><br>
                <label>Website: <input id="website" value="${data.website}"></label><br>
                <label>Email: <input id="email" value="${data.email}"></label><br>
                <label>GitHub: <input id="github" value="${data.github}"></label><br>
                <label>Phone: <input id="phone" value="${data.phone}"></label><br>
                <label>Classes: <input id="classes" value="${data.classes}"></label><br>
                <label>Languages: <input id="languages" value="${data.languages}"></label><br>
                <label>Technologies: <input id="technologies" value="${data.technologies}"></label><br>
                <button type="button" onclick="savePersonalDetails()">Save</button>
            </form>
            `;
        }

        function savePersonalDetails() {
            data.name = document.getElementById("name").value;
            data.location = document.getElementById("location").value;
            data.major = document.getElementById("major").value;
            data.minor = document.getElementById("minor").value;
            data.gpa = document.getElementById("gpa").value;
            data.school = document.getElementById("school").value;
            data.gradYear = document.getElementById("gradYear").value;
            data.website = document.getElementById("website").value;
            data.email = document.getElementById("email").value;
            data.github = document.getElementById("github").value;
            data.phone = document.getElementById("phone").value;
            data.classes = document.getElementById("classes").value;
            data.languages = document.getElementById("languages").value;
            data.technologies = document.getElementById("technologies").value;
            localStorage.setItem("applicantData", JSON.stringify(data));
            alert("Personal details saved!");
            showPersonalDetails();
        }

        /* -------- JOB APPLICATION -------- */
        function editJobApplication() {
            document.getElementById("displayArea").innerHTML = `
                <h2>Edit Job Application</h2>
                <form id="jobForm">
                    <label>Title: <input id="title" value="${jobData.title}"></label><br>
                    <label>Company: <input id="company" value="${jobData.company}"></label><br>
                    <label>Description: <textarea id="description">${jobData.description}</textarea></label><br>
                    <button type="button" onclick="saveJobApplication()">Save</button>
                </form>
            `;
        }

        function saveJobApplication() {
            jobData.title = document.getElementById("title").value;
            jobData.company = document.getElementById("company").value;
            jobData.description = document.getElementById("description").value;
            localStorage.setItem("jobApplication", JSON.stringify(jobData));
            alert("Job application saved!");
            showJobApplication();
        }

        function showJobApplication() {
            displayArea.innerHTML = `<h2>Job Application</h2>
                <p><strong>Title:</strong> ${jobData.title}</p>
                <p><strong>Company:</strong> ${jobData.company}</p>
                <p><strong>Description:</strong></p>
                <pre>${jobData.description}</pre>`;
        }

        /* -------- AI BULLET POINT GENERATION -------- */
        async function generateAIContent(system, user) {

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [
                        { role: "system", content: system },
                        { role: "user", content: user }
                    ]
                })
            });

            const result = await response.json();
            return result.choices[0].message.content.trim();
        }

        async function regenerateBulletPoint(index) {
            const systemPrompt = `Regenerate a professional resume bullet point for this description: ${jobData.description}`;
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: [{ role: "system", content: systemPrompt }]
                })
            });

            const result = await response.json();
            bulletPoints[index] = result.choices[0].message.content.trim();
            displayBulletPoints();
        }

        /* -------- RESUME GENERATION -------- */
        async function generateResume() {
            console.log("generating resume...");

            const data = JSON.parse(localStorage.getItem("applicantData"));
            const professionalDetails = JSON.parse(localStorage.getItem("aiSelectedProfessionalDetails")) || [];
            const experienceDetails = JSON.parse(localStorage.getItem("aiSelectedExperienceDetails")) || [];
            const languages = ["Python", "JavaScript", "Java", "C", "C#", "C++", "TypeScript", "Swift", "Kotlin", "PHP", "Rust",
                "Go", "Ruby", "SQL", "R", "MATLAB", "Shell", "Objective-C", "Assembly", "Prolog", "PowerShell",
                "Bash", "HTML", "CSS", "XML", "Unity", "Arduino", "Unreal Engine", "Agile"];

            function boldLanguages(text) {
                languages.forEach(language => {
                    const regex = new RegExp(`\\b${language.replace(/\+/g, '\\+')}\\b`, 'g');
                    text = text.replace(regex, `<span class='bold'>${language}</span>`);
                });
                return text;
            }

            function boldNumbers(text) {
                return text.replace(/\b\d+\b/g, '<span class="bold">$&</span>');
            }

            let html = `<!DOCTYPE html>
            <html lang="en">
            <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
            @page { size: A4; margin: 0.25in; }
            body { font-family: 'Times New Roman', serif; font-size: 11px; line-height: .6; margin: 0; width: 100%; height: auto; }
            #title { font-size: 18px; text-align: center; font-weight: bold; margin-top: 30px; }
            p { padding-left: 10px; padding-right: 10px; }
            .section p { margin-bottom: -4px; }
            .bold { font-weight: bold; }
            #subheader { text-align: center; }
            .category { text-align: center; font-weight: bold; text-decoration: underline; }
            hr { border: none; height: 2px; width: 95%; background-color: black; }
            .italic { font-style: italic; }
            .right { float: right; }
            .role { line-height:1; }
            .bullet { line-height:1.25; padding-bottom: 0px; margin: 0; }
            </style>
            </head>
            <body>`;

            html += `<p id='title'>${data.name}</p>`;
            html += `<p id='subheader'>${data.location} | ${data.phone} | <a href='${data.website}'>${data.website}</a> | <a href='${data.github}'>${data.github}</a> | ${data.email}</p>`;
            html += "<hr>";

            html += "<p class='category'>EDUCATION</p>";
            html += `<div class='section'>
            <p><span class='bold'>${data.school}</span><span class='right bold'>${data.gradYear}</span></p>
            <p><span class='bold'>Majors: </span>${data.major}</p>
            <p><span class='bold'>Minors: </span>${data.minor}</p>
            <p><span class='bold'>Cumulative GPA: </span>${data.gpa}</p>
            <p><span class='bold' style='line-height: 2;'>Coursework: </span>${data.classes}</p>
            </div><br>`;

            html += "<p class='category'>PROFESSIONAL EXPERIENCE</p>";
            html += "<div class='section'>";
            professionalDetails.forEach(detail => {
                html += `<p><span class='bold'>${detail.title}</span>, ${detail.location}<span class='bold right'>${detail.dates}</span></p>`;
                html += `<p class='role italic'>&nbsp;${detail.role}</p><br>`;
                detail.bulletPoints.forEach(bullet => {
                    html += `<p class='bullet'>&nbsp;&#x2022; ${boldNumbers(boldLanguages(bullet))}</p><br>`;
                });
                html += "<br>";
            });
            html += "</div>";

            html += "<p class='category'>ACTIVITIES AND PROJECTS</p>";
            html += "<div class='section'>";
            experienceDetails.forEach(detail => {
                let location = detail.location;
                if (location.startsWith("http://") || location.startsWith("https://")) {
                    location = `<a href='${location}'>${location}</a>`;
                }
                html += `<p><span class='bold'>${detail.title}</span>, ${location}<span class='bold right'>${detail.dates}</span></p>`;
                html += `<p class='role italic'>&nbsp;${detail.role}</p><br>`;
                detail.bulletPoints.forEach(bullet => {
                    html += `<p class='bullet'>&nbsp;&#x2022; ${boldNumbers(boldLanguages(bullet))}</p><br>`;
                });
                html += "<br>";
            });
            html += "</div>";

            html += "<p class='category'>SKILLS AND INTERESTS</p>";
            html += `<div class='section'>
            <p><span class='bold'>Languages: </span>${data.languages}</p>
            <p><span class='bold'>Technologies: </span>${data.technologies}</p>
            </div>`;

            html += "</body></html>";

            const newTab = window.open();
            newTab.document.write(html);
            newTab.document.close();
        }

        /* -------- COVER LETTER GENERATION -------- */


        async function companyParagraph() {
            console.log("generating cover company paragraph...");

            const filteredKeywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };

            const systemPrompt = "You are writing a cover letter. You will be given a company and a job description. Talk about something specific about that company for an applicant. Add keywords if they're relevant. The paragraph should be 3 sentences.";
            const userPrompt = `keywords: ${filteredKeywords.keywords.join(", ")}\ncompany: ${jobData.company}\njob description: ${jobData.description}`;

            const paragraph = await generateAIContent(systemPrompt, userPrompt);

            return paragraph;
        }

        async function meCoverLetter() {
            console.log("generating cover me paragraph...");

            const filteredKeywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };

            let allExperiences = "";
            professionalDetails.forEach((detail, index) => {
                allExperiences += `${index + 1}: ${detail.title}. ${detail.bulletPoints.join(". ")}. \n`;
            });

            experienceDetails.forEach((detail, index) => {
                allExperiences += `${index + professionalDetails.length + 1}: ${detail.title}. ${detail.bulletPoints.join(". ")}. \n`;
            });

            const systemPrompt = "I'm going to give you a list of numbered experiences for a resume. I want you to give me the number and just the number of the most relevant experience.";
            const userPrompt = `Job description: ${jobData.description}\nExperiences: ${allExperiences}`;

            const response = await generateAIContent(systemPrompt, userPrompt);
            const answer = parseInt(response) - 1;

            let experience;
            if (answer < professionalDetails.length) {
                experience = `${professionalDetails[answer].title}: ${professionalDetails[answer].bulletPoints.join(". ")}`;
            } else {
                const expIndex = answer - professionalDetails.length;
                experience = `${experienceDetails[expIndex].title}: ${experienceDetails[expIndex].bulletPoints.join(". ")}`;
            }

            const coverSystemPrompt = "You are writing a cover letter. I want you to write a paragraph of 3 sentences based on the given experience. Also add in the given keywords if relevant.";
            const coverUserPrompt = `keywords: ${filteredKeywords.keywords.join(", ")}\nexperience: ${experience}`;

            const paragraph = await generateAIContent(coverSystemPrompt, coverUserPrompt);

            return paragraph;
        }



        async function generateCoverLetter() {
            const preletter = `${data.name}
${data.phone}
${data.email}

Dear Hiring Team,
`;
            // 
            const intro = `I am writing to express my strong interest in the ${jobData.title} position at ${jobData.company}. As a highly skilled and motivated programmer with a passion for innovation, I believe that my technical expertise and dedication to excellence make me an ideal candidate for this role.`;

            const meParagraph = await meCoverLetter();

            const comParagraph = await companyParagraph();

            const passionParagraph = `What excites me is the chance to continuously grow as a programmer while making a meaningful impact on people's lives. As someone with a strong growth mindset, I am constantly seeking out challenges that push me to learn new skills, explore different technologies, and refine my problem-solving abilities. I'm excited by the prospect of working with a team that shares a similar passion for learning and innovation.`;

            const endParagraph = `In closing, I am thrilled about the opportunity to join the talented team at ${jobData.company} and contribute. I am confident that my technical expertise, passion for innovation, and dedication to excellence make me a strong fit for this role. Thank you for considering my application. I look forward to the possibility of discussing how my skills and experience align with ${jobData.company}'s vision.`;

            const postParagragh = `Cheers,
${data.name}`;
            const coverLetter = `${preletter}${intro} \n\n${meParagraph} \n\n${comParagraph} \n\n${passionParagraph} \n\n${postParagragh}`;
            const newTab = window.open();
            newTab.document.write(`<pre style="text-wrap: wrap;">${coverLetter}`);
            newTab.document.close();
        }

        /* -------- KEYWORD GENERATION -------- */
        // JavaScript function to call Flask API
        async function generateKeywords() {
            const inputText = jobData.description;
            console.log(jobData.company)
            try {
                const response = await fetch('https://flask-keyword-extractor.vercel.app/', { // Update URL if hosted elsewhere
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: inputText, company: jobData.company })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const keywords = await response.json();
                console.log('Extracted Keywords:', keywords); // Display extracted keywords

                // Save keywords to local storage
                localStorage.setItem("extractedKeywords", JSON.stringify(keywords));
            } catch (error) {
                console.error('Error calling Flask API:', error);
            }
        }

        function showKeywords() {
            const keywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };
            const bulletPoints = JSON.parse(localStorage.getItem("aiSelectedProfessionalDetails")) || [];
            const allBulletPoints = bulletPoints.flatMap(detail => detail.bulletPoints);

            let foundKeywords = [];
            let missingKeywords = [...keywords.keywords];

            allBulletPoints.forEach(bullet => {
                keywords.keywords.forEach(keyword => {
                    if (bullet.includes(keyword) && !foundKeywords.includes(keyword)) {
                        foundKeywords.push(keyword);
                        missingKeywords = missingKeywords.filter(k => k !== keyword);
                    }
                });
            });

            let html = "<h2>Extracted Keywords</h2>";
            html += "<h3>Found Keywords</h3><ul>";
            foundKeywords.forEach((keyword) => {
                html += `<li>${keyword} <button onclick="deleteKeyword('${keyword}')">Delete</button></li>`;
            });
            html += "</ul>";

            html += "<h3>Missing Keywords</h3><ul>";
            missingKeywords.forEach((keyword) => {
                html += `<li>${keyword} <button onclick="deleteKeyword('${keyword}')">Delete</button></li>`;
            });
            html += "</ul>";

            displayArea.innerHTML = html;
        }

        function deleteKeyword(keyword) {
            const keywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };
            keywords.keywords = keywords.keywords.filter(k => k !== keyword);
            localStorage.setItem("extractedKeywords", JSON.stringify(keywords));
            showKeywords();
        }

        /* -------- AI GENERATION -------- */
        async function decideExperiences() {
            console.log("deciding experiences...");

            await generateKeywords(); // Generate keywords before deciding experiences

            const types = ["professionalDetails", "experienceDetails"];
            const amounts = [3, 5]; // specify the number of experiences for professional and experience details

            for (let i = 0; i < types.length; i++) {
                const type = types[i];
                const amount = amounts[i];
                let allExperiences = "";
                const allDetails = type === "professionalDetails" ? professionalDetails : experienceDetails;

                for (const detail of allDetails) {
                    const bestBulletPoints = await decideBestBulletPoints(detail.bulletPoints);
                    detail.bulletPoints = bestBulletPoints;
                }

                allDetails.forEach((detail, index) => {
                    allExperiences += `${index + 1}: ${detail.title}. ${detail.bulletPoints.join(". ")}. \n`;
                });

                const systemPrompt = `I'm going to give you a list of numbered experiences for a resume. I want you to give me the numbers and just the numbers of the ${amount} most relevant experience details.`;
                const userPrompt = `Job description: ${jobData.description}\nExperiences: ${allExperiences}`;

                try {
                    const response = await generateAIContent(systemPrompt, userPrompt);
                    const experienceNums = response.split(',').map(num => parseInt(num.trim()) - 1);

                    const relevantExperiences = experienceNums.map(num => allDetails[num]);
                    console.log("Using experiences", relevantExperiences);

                    // Save relevant experiences to local storage
                    localStorage.setItem(`aiSelected${type.charAt(0).toUpperCase() + type.slice(1)}`, JSON.stringify(relevantExperiences));
                } catch (error) {
                    console.error("Error deciding experiences:", error);
                }
            }
            showAIExperiences();
        }
        async function decideBestBulletPoints(bulletPoints) {
            if (bulletPoints.length <= 3) {
                return bulletPoints;
            }

            const systemPrompt = "I'm going to give you a list of numbered bullet points for a resume. I want you to give me the numbers and just the numbers of the 3 most relevant bullet points separated by commas. Say \"1, 2\" if there are only 2 bullet points.";
            const userPrompt = `Description: ${jobData.description}\nBullet Points: ${bulletPoints.map((b, i) => `${i + 1}: ${b}`).join("\n")}`;

            try {
                const response = await generateAIContent(systemPrompt, userPrompt);
                const bulletNums = response.split(',').map(num => parseInt(num.trim()) - 1);

                const relevantBullets = bulletNums.map(num => bulletPoints[num]);
                console.log("Using bullets", relevantBullets);

                return relevantBullets;
            } catch (error) {
                console.error("Error deciding best bullet points:", error);
                return bulletPoints.slice(0, 3); // Fallback to the first 3 bullet points
            }
        }

        async function showAIExperiences() {
            const displayArea = document.getElementById("displayArea");
            const types = ["professionalDetails", "experienceDetails"];
            const amounts = [3, 5]; // specify the number of experiences for professional and experience details

            let html = "";

            const keywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };
            const allBulletPoints = JSON.parse(localStorage.getItem("aiSelectedProfessionalDetails"))?.flatMap(detail => detail.bulletPoints) || [];
            const foundKeywords = [];
            let missingKeywords = [...keywords.keywords];

            allBulletPoints.forEach(bullet => {
                keywords.keywords.forEach(keyword => {
                    if (bullet.includes(keyword) && !foundKeywords.includes(keyword)) {
                        foundKeywords.push(keyword);
                        missingKeywords = missingKeywords.filter(k => k !== keyword);
                    }
                });
            });

            html += `<h2>Missing Keywords</h2><p>${missingKeywords.join(", ")}</p>`;

            for (let i = 0; i < types.length; i++) {
                const type = types[i];
                const amount = amounts[i];
                let experiences = JSON.parse(localStorage.getItem(`aiSelected${type.charAt(0).toUpperCase() + type.slice(1)}`)) || [];

                html += `<h2>AI Selected ${type === "professionalDetails" ? "Professional" : "Experience"} Details</h2>`;
                experiences.forEach((detail, index) => {
                    html += `<div>
            <h3>${detail.title}</h3>
            <p><strong>Dates:</strong> ${detail.dates}</p>
            <p><strong>Location:</strong> ${detail.location}</p>
            <p><strong>Role:</strong> ${detail.role}</p>
            <ul>${detail.bulletPoints.map((b, i) => `<li>${b} <button onclick="rewriteBulletPoint('${type}', ${index}, ${i})">Rewrite</button></li>`).join("")}</ul>
            </div>`;
                });
            }

            displayArea.innerHTML = html;
        }

        async function rewriteBulletPoint(type, detailIndex, bulletIndex) {
            const allDetails = JSON.parse(localStorage.getItem(`aiSelected${type.charAt(0).toUpperCase() + type.slice(1)}`)) || [];
            const detail = allDetails[detailIndex];
            const bulletPoint = detail.bulletPoints[bulletIndex];

            const keywords = JSON.parse(localStorage.getItem("extractedKeywords")) || { keywords: [] };
            const missingKeywords = keywords.keywords.filter(keyword => !bulletPoint.includes(keyword));

            const systemPrompt = "You are a job application assistant used for resumes. You will be given keywords. Your job is to take the given bullet points and rewrite the bullet point to include keywords if and only if you can add a relevant keyword. If no keywords are relevant, give back the sentence as is. The amount of characters should be around 140 but not higher.";
            const userPrompt = `Keywords: ${missingKeywords.join(", ")}\nBullet Point: ${bulletPoint}\n`;

            const newBulletPoint = await generateAIContent(systemPrompt, userPrompt);

            detail.bulletPoints[bulletIndex] = newBulletPoint;
            localStorage.setItem(`aiSelected${type.charAt(0).toUpperCase() + type.slice(1)}`, JSON.stringify(allDetails));
            showAIExperiences();
        }


        /* -------- EXPORT AND IMPORT LOCAL STORAGE -------- */
        function exportLocalStorage() {
            const data = {
                applicantData: localStorage.getItem("applicantData"),
                professionalDetails: localStorage.getItem("professionalDetails"),
                experienceDetails: localStorage.getItem("experienceDetails"),
                jobApplication: localStorage.getItem("jobApplication"),
                extractedKeywords: localStorage.getItem("extractedKeywords")
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "localStorageData.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importLocalStorage(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (event) {
                const data = JSON.parse(event.target.result);
                localStorage.setItem("applicantData", data.applicantData);
                localStorage.setItem("professionalDetails", data.professionalDetails);
                localStorage.setItem("experienceDetails", data.experienceDetails);
                localStorage.setItem("jobApplication", data.jobApplication);
                localStorage.setItem("extractedKeywords", data.extractedKeywords);
                alert("Local storage data imported successfully!");
                location.reload(); // Refresh the page to reflect the imported data
            };
            reader.readAsText(file);
        }


    </script>

</body>

</html>